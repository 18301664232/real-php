<link rel="stylesheet" type="text/css" href="<?php echo STATICS ?>css/flow.css">

<body>
    <div class="flow-box">

        <div class="pay-box">
            <div class="pay-type-sec">
                <div class="pay-type-head clearfix">
                    <!-- 这里有跳转页面 -->
                    <p class="pay-type-head-text">支付方式</p><a class="pay-type-head-return" href="<?php echo U('finance/pay/select') ?>">返回选择页面</a></div>
                <div class="pay-type-body clearfix">
                    <button class="pay-type-wx pay-type-selected">微信支付<div class="pay-type-selected-sign"></div></button>
                    <button class="pay-type-zfb">支付宝支付<div class="pay-type-selected-sign"></div></button>
                </div>
                <div class="pay-type-divider clearfix">
                    <div class="pay-type-divider-unit" data-num="0"></div>
                    <div class="pay-type-divider-unit" data-num="1"></div>
                    <div class="pay-type-divider-unit" data-num="2"></div>
                    <div class="pay-type-divider-unit" data-num="3"></div>
                    <div class="pay-type-divider-unit" data-num="4"></div>
                    <div class="pay-type-divider-unit" data-num="5"></div>
                    <div class="pay-type-divider-unit" data-num="6"></div>
                    <div class="pay-type-divider-unit" data-num="7"></div>
                    <div class="pay-type-divider-unit" data-num="8"></div>
                    <div class="pay-type-divider-unit" data-num="9"></div>
                    <div class="pay-type-divider-unit" data-num="10"></div>
                    <div class="pay-type-divider-unit" data-num="11"></div>
                    <div class="pay-type-divider-unit" data-num="12"></div>
                    <div class="pay-type-divider-unit" data-num="13"></div>
                    <div class="pay-type-divider-unit" data-num="14"></div>
                    <div class="pay-type-divider-unit" data-num="15"></div>
                    <div class="pay-type-divider-unit" data-num="16"></div>
                    <div class="pay-type-divider-unit" data-num="17"></div>
                    <div class="pay-type-divider-unit" data-num="18"></div>
                    <div class="pay-type-divider-unit" data-num="19"></div>
                    <div class="pay-type-divider-unit" data-num="20"></div>
                    <div class="pay-type-divider-unit" data-num="21"></div>
                    <div class="pay-type-divider-unit" data-num="22"></div>
                    <div class="pay-type-divider-unit" data-num="23"></div>
                    <div class="pay-type-divider-unit" data-num="24"></div>
                    <div class="pay-type-divider-unit" data-num="25"></div>
                    <div class="pay-type-divider-unit" data-num="26"></div>
                    <div class="pay-type-divider-unit" data-num="27"></div>
                    <div class="pay-type-divider-unit" data-num="28"></div>
                    <div class="pay-type-divider-unit" data-num="29"></div>
                    <div class="pay-type-divider-unit" data-num="30"></div>
                    <div class="pay-type-divider-unit" data-num="31"></div>
                    <div class="pay-type-divider-unit" data-num="32"></div>
                    <div class="pay-type-divider-unit" data-num="33"></div>
                    <div class="pay-type-divider-unit" data-num="34"></div>
                    <div class="pay-type-divider-unit" data-num="35"></div>
                    <div class="pay-type-divider-unit" data-num="36"></div>
                    <div class="pay-type-divider-unit" data-num="37"></div>
                    <div class="pay-type-divider-unit" data-num="38"></div>
                    <div class="pay-type-divider-unit" data-num="39"></div>
                    <div class="pay-type-divider-unit" data-num="40"></div>
                    <div class="pay-type-divider-unit" data-num="41"></div>
                    <div class="pay-type-divider-unit" data-num="42"></div>
                    <div class="pay-type-divider-unit" data-num="43"></div>
                    <div class="pay-type-divider-unit" data-num="44"></div>
                    <div class="pay-type-divider-unit" data-num="45"></div>
                    <div class="pay-type-divider-unit" data-num="46"></div>
                    <div class="pay-type-divider-unit" data-num="47"></div>
                    <div class="pay-type-divider-unit" data-num="48"></div>
                    <div class="pay-type-divider-unit" data-num="49"></div>
                    <div class="pay-type-divider-unit" data-num="50"></div>
                    <div class="pay-type-divider-unit" data-num="51"></div>
                    <div class="pay-type-divider-unit" data-num="52"></div>
                    <div class="pay-type-divider-unit" data-num="53"></div>
                    <div class="pay-type-divider-unit" data-num="54"></div>
                    <div class="pay-type-divider-unit" data-num="55"></div>
                    <div class="pay-type-divider-unit" data-num="56"></div>
                    <div class="pay-type-divider-unit" data-num="57"></div>
                    <div class="pay-type-divider-unit" data-num="58"></div>
                    <div class="pay-type-divider-unit" data-num="59"></div>
                    <div class="pay-type-divider-unit" data-num="60"></div>
                    <div class="pay-type-divider-unit" data-num="61"></div>
                    <div class="pay-type-divider-unit" data-num="62"></div>
                    <div class="pay-type-divider-unit" data-num="63"></div>
                    <div class="pay-type-divider-unit" data-num="64"></div>
                    <div class="pay-type-divider-unit" data-num="65"></div>
                    <div class="pay-type-divider-unit" data-num="66"></div>
                    <div class="pay-type-divider-unit" data-num="67"></div>
                    <div class="pay-type-divider-unit" data-num="68"></div>
                    <div class="pay-type-divider-unit" data-num="69"></div>
                    <div class="pay-type-divider-unit" data-num="70"></div>
                    <div class="pay-type-divider-unit" data-num="71"></div>
                    <div class="pay-type-divider-unit" data-num="72"></div>
                    <div class="pay-type-divider-unit" data-num="73"></div>
                    <div class="pay-type-divider-unit" data-num="74"></div>
                    <div class="pay-type-divider-unit" data-num="75"></div>
                    <div class="pay-type-divider-unit" data-num="76"></div>
                    <div class="pay-type-divider-unit" data-num="77"></div>
                </div>
            </div>
            <div class="pay-info-sec">
                <div class="pay-info-head">
                    <p class="pay-info-head-text">订单信息</p>
                </div>
                <div class="pay-table-box">
                    <table class="table pay-table">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>单价</th>
                                <th>期限</th>
                                <th>数量</th>
                                <th>小计</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (!empty($data)): ?>
                                <?php foreach ($data as $k => $v): ?>
                                    <tr val="<?php echo $v['id'] ?>">
                                        <td><?php echo $v['name'] ?></td>
                                        <td class="pay-table-unit">￥<?php echo $v['money'] ?></td>
                                        <td><?php echo date('Y-m-d', time()) ?>/<?php echo date('Y-m-d', time() + 3600 * 24 * $v['timespan']) ?></td>
                                        <td>
                                            <div class="pay-table-num clearfix"><button class="pay-table-num-decrease">-</button>
                                                <p class="pay-table-num-show"><?php echo isset($v['count']) ? $v['count'] : 1 ?></p><button class="pay-table-num-increase">+</button></div>
                                        </td>
                                        <td class="pay-table-sub">￥00.00</td>
                                        <td><button class="pay-table-delete">删除</button></td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            <!--            <div class="pay-pre-sec">
                            <div class="pay-pre1 clearfix">
                                <div class="pay-pre1-box clearfix">
                                    <p class="pay-pre1-text">选择优惠券：</p><button class="pay-pre1-btn">无<div class="pay-pre1-tri-box"></div><div class="pay-pre-tri"></div></button></div>
                            </div>
                            <div class="pay-pre2 clearfix">
                                <p><span class="pay-pre2-key">优惠金额：</span><span class="pay-pre2-val">￥00.00</span></p>
                            </div>
                            <div class="pay-pre3 clearfix">
                                <p><span class="pay-pre3-key">订单金额：</span><span class="pay-pre3-val">￥00.00</span></p>
                            </div>
                        </div>-->
            <div class="pay-sure-sec">
                <div class="pay-sure1 clearfix">
                    <div class="pay-sure1-right clearfix"><span class="pay-sure1-key">实付金额：</span><span class="pay-sure1-val">￥00.00</span></div>
                </div>
                <div class="pay-sure2 clearfix"><button class="pay-sure2-btn"><div class="pay-sure2-btn-t"></div><div class="pay-sure2-btn-m">确认支付</div><div class="pay-sure2-btn-b"></div></button></div>
            </div>
        </div>
        <div class="modal pay-alert-box" id="pay-alert" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog pay-alert-width" role="document">
                <div class="modal-content pay-alert-height">
                    <div class="pay-alert-close clearfix"><button class="pay-alert-close-btn" data-dismiss="modal"></button></div>
                    <p class="pay-alert-price"><span class="pay-alert-price-key">支付金额：&nbsp;</span><span class="pay-alert-price-val">￥0</span></p>
                    <div class="pay-alert-qr"><img class="pay-alert-qr-img" src="">
                        <div class="pay-alert-qr-mask">二维码已经失效</div>
                    </div>
                    <div class="pay-alert-tip-box">
                        <p class="pay-alert-tip">请打开微信扫一扫，扫描二维码支付</p>
                        <p class='pay-alert-time'> 此二维码30分钟内有效</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal pay-alert-box-zfb" id="pay-alert-zfb" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog pay-alert-width" role="document">
                <div class="modal-content pay-alert-height">
                    <div class="pay-alert-close-zfb clearfix"><button class="pay-alert-close-btn-zfb" data-dismiss="modal"></button></div>
                    <p class="pay-alert-price-zfb"><span class="pay-alert-price-key-zfb">支付金额：&nbsp;</span><span class="pay-alert-price-val-zfb">￥0</span></p>
                    <div class="pay-alert-qr-zfb">
                        <div class="pay-alert-qr-mask-zfb">二维码已经失效</div><iframe class="pay-alert-iframe-zfb" scrolling="no"></iframe></div>
                    <div class="pay-alert-tip-box-zfb">
                        <p class="pay-alert-tip-zfb">请打开支付宝扫一扫，扫描二维码支付</p>
                        <p class="pay-alert-time-zfb">此二维码30分钟内有效</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

</body>
<script type="text/javascript">
    //计算总价的函数
    function countPrice() {
        var totle = 0;
        var totleString = '';
        for (var i = 0; i < $('.pay-table > tbody > tr').length; i++) {
            var unitPrice = parseInt($('.pay-table > tbody > tr').eq(i).find('.pay-table-unit').text().replace('￥', ''));
            var number = parseInt($('.pay-table > tbody > tr').eq(i).find('.pay-table-num-show').text());
            var subTotle = unitPrice * number;
            var sunTotleString = '￥' + subTotle + '.00';
            $('.pay-table > tbody > tr').eq(i).find('.pay-table-sub').text(sunTotleString);
            totle += subTotle;
        }
        totleString = '￥' + totle + '.00';
        $('.pay-sure1-val').text(totleString);
    }
    countPrice();
    //增加商品数量
    $('.pay-table').on('click', '.pay-table-num-increase', function () {
        if (Number($(this).siblings('.pay-table-num-show').text()) < 99) {
            $(this).siblings('.pay-table-num-show').text(Number($(this).siblings('.pay-table-num-show').text()) + 1);
            countPrice();
        }
    });

    //减少商品数量
    $('.pay-table').on('click', '.pay-table-num-decrease', function () {
        if (Number($(this).siblings('.pay-table-num-show').text()) > 1) {
            $(this).siblings('.pay-table-num-show').text(Number($(this).siblings('.pay-table-num-show').text()) - 1);
            countPrice();
        }
    });
    //删除订单
    $('.pay-table').on('click', '.pay-table-delete', function () {
        $(this).parents('tr').remove();
        countPrice();
        if ($('.pay-table > tbody > tr').length === 0) {
            $('.pay-sure2-btn').attr('disabled', 'disabled');
        }
    });


    //二维码失效提示的逻辑
    $('.pay-alert-close-btn').on('click', function () {
        $('.pay-alert-qr-mask').hide();
    });

    function qrInvalid(time) {
        var time = parseInt(time) * 1000;
        setTimeout(function () {
            $('.pay-alert-qr-mask').show();
        }, time);
    }
    ;
    //支付弹窗
    $('.pay-sure2-btn').on('click', function () {
        socket = io.connect('http://123.56.177.30:3080');
        var key;
        var myArray = new Array();
        $('tbody tr').each(function () {
            var id = $(this).attr('val');
            var count = $(this).find('.pay-table-num-show').html();
            myArray[id] = id + ',' + count;
        });
        var str = JSON.stringify(myArray);
        if ($('.pay-type-selected').hasClass('pay-type-wx')) {
            var status = 'wx';
        } else if ($('.pay-type-selected').hasClass('pay-type-zfb')) {
            var status = 'zfb';
        }
        $.ajax({
            type: "POST",
            url: '<?php echo U('finance/pay/creatinfo') ?>',
            data: {
                data: str,
                status: status
            },
            dataType: 'json',
            success: function (data) {
                if (data.code == 1) {
                    var totleString = '￥' + data.result.total + '.00';
                    $('.pay-alert-price-val').html(totleString);
                    var imgs = '<?php echo REAL . U('common/qrcode/code', array('type' => 'wx')) ?>' + '&url=' + data.result.url;
                    $('.pay-alert-qr-img').attr('src', imgs);

                    key = data.result.order_no;

                    socket.emit('join', {
                        key: key
                    });
                    qrInvalid(1800);
                    $('.pay-alert-width').css('margin-top', $(window).height() > $('.pay-alert-height').outerHeight() ? (($(window).height() - $('.pay-alert-height').outerHeight()) / 2) + 'px' : '0px');
                    $('#pay-alert').modal({
                        show: true,
                        backdrop: 'static'
                    })
                }
                if (data.code == 2) {
                    var totleString = '￥' + data.result.total + '.00';
                    $('.pay-alert-price-val-zfb').html(totleString);

                    key = data.result.order_no;
                    socket.emit('join', {
                        key: key
                    });
//                        $('.pay-alert-iframe-zfb').attr('src','<?php echo REAL . '/zfbzf/index.php?data=' ?>'+data.result.order_no);
//                        $('.pay-alert-iframe-zfb').on('load',function(){
//                             $('.pay-alert-width').css('margin-top',$(window).height() > $('.pay-alert-height').outerHeight()?(($(window).height() - $('.pay-alert-height').outerHeight())/2) + 'px':'0px');
//                            $('#pay-alert-zfb').modal({
//                               // $('.pay-alert-width').css('margin-top',$(window).height() > $('.pay-alert-height').outerHeight()?(($(window).height() - $('.pay-alert-height').outerHeight())/2) + 'px':'0px');
//                               
//                                show:true,
//                                backdrop:'static'
//                            })
//                        });
                    $('.pay-alert-width').css('margin-top', $(window).height() > $('.pay-alert-height').outerHeight() ? (($(window).height() - $('.pay-alert-height').outerHeight()) / 2) + 'px' : '0px');
                    $('#pay-alert-zfb').modal({
                        show: true,
                        backdrop: 'static'
                    })
                    $('.pay-alert-qr-zfb').append('<div class="pay-alert-qr-load"></div>');

                    $('.pay-alert-iframe-zfb').attr('src', '<?php echo REAL . '/zfbzf/index.php?data=' ?>' + data.result.order_no);
                    $('.pay-alert-iframe-zfb').on('load', function () {
                        $('.pay-alert-qr-load').remove();
                    });

                }


            }

        });


        socket.on('message', function (msg) {
            var result = msg.msg;
            var code = 1;
            if (result) {
                var code = result.code || 1;
            }
            if (code == 0) {
                socket.disconnect();
                window.location.href = '<?php echo U('finance/pay/sus') ?>';

            }


        });

    });
    //选择支付方式
    $('.pay-type-body > button').on('click', function () {
        $('.pay-type-body > button').removeClass('pay-type-selected');
        $(this).addClass('pay-type-selected');
    });


</script>

